<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½è®¾å¤‡ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body {
            font-family: "Microsoft Yahei", Arial, sans-serif;
            margin: 20px;
            background-color: #f5f7fa;
        }

        /* æ ‡é¢˜åŒº */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .main-title {
            color: #2c3e50;
            font-size: 2.5em;
            margin: 0 0 15px 0;
            letter-spacing: 2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .broadcast {
            background: #fff9e6;
            padding: 12px;
            border-radius: 8px;
            color: #e67e22;
            margin: 0 auto 20px;
            max-width: 800px;
            animation: fadeIn 1s;
            border: 1px solid #ffeeba;
            transition: all 0.3s;
        }

        /* çŠ¶æ€åŒº */
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 auto 20px;
            max-width: 1200px;
            padding: 0 10px;
        }

        .refresh-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .refresh-btn {
            padding: 8px 20px;
            background: #3498db;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
            border: none;
        }

        .refresh-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .refresh-time {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        /* è®¾å¤‡çŠ¶æ€å¡ç‰‡ */
        .status-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .device-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            width: 280px;
            min-height: 200px;
            transition: transform 0.3s;
        }

        .device-card:hover {
            transform: translateY(-3px);
        }

        .device-title {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            font-size: 1.2em;
        }

        .status-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .normal { background-color: #4CAF50; }
        .warning { background-color: #FFC107; }
        .error { background-color: #F44336; }

        .metric-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .metric-list li {
            margin: 15px 0;
            color: #666;
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .metric-list li:last-child {
            border-bottom: none;
        }

        /* æ“ä½œåŒº */
        .operations {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            max-width: 800px;
            margin: 30px auto;
        }

        .operation-group {
            padding: 15px 0;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .operation-group:not(:last-child) {
            border-bottom: 2px solid #eee;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: 0.3s;
            min-width: 120px;
            font-weight: 500;
            letter-spacing: 1px;
        }

        .btn-start { 
            background-color: #4CAF50; 
            color: white; 
        }

        .btn-stop { 
            background-color: #F44336; 
            color: white; 
        }

        .btn-reset { 
            background-color: #9E9E9E; 
            color: white; 
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .status-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .device-card {
                width: 100%;
                max-width: 400px;
            }

            .operation-group {
                flex-wrap: wrap;
            }

            button {
                width: 100%;
                max-width: 200px;
            }

            .main-title {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <!-- æ ‡é¢˜åŒº -->
    <div class="header">
        <h1 class="main-title">ğŸ­ æ™ºèƒ½è®¾å¤‡ç›‘æ§ç³»ç»Ÿ ğŸŒ¡ï¸</h1>
        <div class="broadcast" id="broadcast">
            ğŸ“¢ ç³»ç»Ÿåˆå§‹åŒ–ä¸­...
        </div>
    </div>

    <!-- çŠ¶æ€åŒº -->
    <div class="status-header">
        <h2>ğŸ“Š è®¾å¤‡å®æ—¶çŠ¶æ€</h2>
        <div class="refresh-area">
            <div class="refresh-time">ğŸ•’ æœ€ååˆ·æ–°æ—¶é—´ï¼š<span id="time">--</span></div>
            <div class="refresh-btn" onclick="refreshData()">ğŸ”„ ç«‹å³åˆ·æ–°</div>
        </div>
    </div>

    <!-- è®¾å¤‡çŠ¶æ€ -->
    <div class="status-container">
        <!-- ç©ºè°ƒç³»ç»Ÿ -->
        <div class="device-card" id="air-conditioner">
            <h2 class="device-title">
                <span class="status-indicator"></span>
                â„ï¸ ç©ºè°ƒç³»ç»Ÿ
            </h2>
            <ul class="metric-list">
                <li><span>æ¸©åº¦ï¼š</span><span class="temp-value">--</span></li>
                <li><span>æ¹¿åº¦ï¼š</span><span class="humidity-value">--</span></li>
                <li><span>é£é€Ÿï¼š</span><span class="wind-value">--</span></li>
            </ul>
        </div>

        <!-- é€šé£ç³»ç»Ÿ -->
        <div class="device-card" id="ventilation">
            <h2 class="device-title">
                <span class="status-indicator"></span>
                ğŸ’¨ é€šé£ç³»ç»Ÿ
            </h2>
            <ul class="metric-list">
                <li><span>æ¸©åº¦ï¼š</span><span class="temp-value">--</span></li>
                <li><span>æ¹¿åº¦ï¼š</span><span class="humidity-value">--</span></li>
                <li><span>é£é€Ÿï¼š</span><span class="wind-value">--</span></li>
            </ul>
        </div>

        <!-- å†·å´ç³»ç»Ÿ -->
        <div class="device-card" id="cooling">
            <h2 class="device-title">
                <span class="status-indicator"></span>
                ğŸŒŠ å†·å´ç³»ç»Ÿ
            </h2>
            <ul class="metric-list">
                <li><span>æ¸©åº¦ï¼š</span><span class="temp-value">--</span></li>
                <li><span>æ¹¿åº¦ï¼š</span><span class="humidity-value">--</span></li>
                <li><span>é£é€Ÿï¼š</span><span class="wind-value">--</span></li>
            </ul>
        </div>
    </div>

    <!-- æ“ä½œåŒº -->
    <div class="operations">
        <div class="operation-group">
            <button class="btn-start" onclick="sendCommand('start')">ğŸš€ å¯åŠ¨è®¾å¤‡</button>
            <button class="btn-stop" onclick="sendCommand('stop')">ğŸ›‘ åœæ­¢è®¾å¤‡</button>
            <button class="btn-reset" onclick="sendCommand('reset')">ğŸ”ƒ é‡ç½®è®¾å¤‡</button>
        </div>
        
        <div class="operation-group">
            <button class="btn-start" onclick="adjustWind('+')">ğŸŒªï¸ é£é€Ÿ+</button>
            <button class="btn-stop" onclick="adjustWind('-')">ğŸƒ é£é€Ÿ-</button>
            <button class="btn-reset" onclick="setAutoMode()">ğŸ¤– è‡ªåŠ¨æ¨¡å¼</button>
        </div>
    </div>

    <script>
        // é…ç½®ESP32æœåŠ¡å™¨åœ°å€ï¼ˆä¿®æ”¹ä¸ºä½ çš„å®é™…IPï¼‰
        const ESP32_IP = '127.0.0.1:4523/m1/5807065-5492102-default';
        const API_URL = `http://${ESP32_IP}/status/device`;

        // è®¾å¤‡æ˜ å°„é…ç½®
        const deviceConfig = {
            'air-conditioner': {
                temp: document.querySelector('#air-conditioner .temp-value'),
                humidity: document.querySelector('#air-conditioner .humidity-value'),
                wind: document.querySelector('#air-conditioner .wind-value'),
                status: document.querySelector('#air-conditioner .status-indicator')
            },
            'ventilation': {
                temp: document.querySelector('#ventilation .temp-value'),
                humidity: document.querySelector('#ventilation .humidity-value'),
                wind: document.querySelector('#ventilation .wind-value'),
                status: document.querySelector('#ventilation .status-indicator')
            },
            'cooling': {
                temp: document.querySelector('#cooling .temp-value'),
                humidity: document.querySelector('#cooling .humidity-value'),
                wind: document.querySelector('#cooling .wind-value'),
                status: document.querySelector('#cooling .status-indicator')
            }
        };

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            getStatusData();
    try {
        toggleRefreshButton(true);

        // æ„é€  URLSearchParams å¯¹è±¡
        var urlencoded = new URLSearchParams();
        // å¦‚æœ API éœ€è¦å…·ä½“å‚æ•°ï¼Œå¯åœ¨è¿™é‡Œæ·»åŠ ï¼Œå¦‚ï¼šurlencoded.append("key", "value");

        const response = await fetch(API_URL, {
            method: 'POST',
            body: urlencoded,
            redirect: 'follow'
        });

        if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);

        const data = await response.json(); // å‡è®¾æ¥å£è¿”å› JSON
        updateUI(data);
        updateBroadcast('âœ… æ•°æ®æ›´æ–°æˆåŠŸ', '#d4edda', '#155724');

    } catch (error) {
        console.error('åˆ·æ–°å¤±è´¥:', error);
        updateBroadcast(`âš ï¸ é”™è¯¯: ${error.message}`, '#f8d7da', '#721c24');
    } finally {
        toggleRefreshButton(false);
        updateTime();
    }
        }

        // æ›´æ–°ç•Œé¢
        function updateUI(data) {
            Object.entries(data).forEach(([deviceId, deviceData]) => {
                const elements = deviceConfig[deviceId];
                if (elements) {
                    elements.temp.textContent = `${deviceData.temperature.toFixed(1)}Â°C`;
                    elements.humidity.textContent = `${Math.round(deviceData.humidity)}%`;
                    elements.wind.textContent = `${deviceData.wind_speed.toFixed(1)}m/s`;
                    elements.status.className = `status-indicator ${deviceData.status}`;
                    animateUpdate(deviceId);
                }
            });
        }

        // æ§åˆ¶å‘½ä»¤å‘é€
        async function sendCommand(command) {
            
            try {
                const response = await fetch(`http://${ESP32_IP}/control?cmd=${command}`);
                if (!response.ok) throw new Error('æ§åˆ¶å‘½ä»¤å‘é€å¤±è´¥');
                updateBroadcast(`ğŸ“¢ å‘½ä»¤æ‰§è¡ŒæˆåŠŸ: ${command}`, '#d4edda', '#155724');
            } catch (error) {
                updateBroadcast(`âš ï¸ æ§åˆ¶å¤±è´¥: ${error.message}`, '#f8d7da', '#721c24');
            }
        }

        // å·¥å…·å‡½æ•°
        function updateTime() {
            const now = new Date();
            document.getElementById('time').textContent = now.toLocaleString();
        }

        function toggleRefreshButton(loading) {
            const btn = document.querySelector('.refresh-btn');
            btn.textContent = loading ? 'ğŸ”„ åŠ è½½ä¸­...' : 'ğŸ”„ ç«‹å³åˆ·æ–°';
            btn.style.opacity = loading ? 0.7 : 1;
        }

        function animateUpdate(deviceId) {
            const card = document.getElementById(deviceId);
            card.style.transform = 'scale(1.02)';
            setTimeout(() => card.style.transform = 'scale(1)', 200);
        }

        function updateBroadcast(message, bgColor, textColor) {
            const broadcast = document.getElementById('broadcast');
            broadcast.textContent = message;
            broadcast.style.backgroundColor = bgColor;
            broadcast.style.color = textColor;
            broadcast.style.borderColor = textColor;
        }

        function getStatusData(){
            var urlencoded = new URLSearchParams();
            var requestOptions = {
             method: 'POST',
            body: urlencoded,
            redirect: 'follow'
            };
            fetch("http://127.0.0.1:4523/m1/5807065-5492102-default/status/device", requestOptions)
           .then(response => response.text())
            .then(result => console.log(result))
            .catch(error => console.log('error', error));
        }

        // åˆå§‹åŒ–
        refreshData(); // é¦–æ¬¡åŠ è½½æ•°æ®
        setInterval(refreshData, 30000); // 30ç§’è‡ªåŠ¨åˆ·æ–°
    </script>
</body>
</html>